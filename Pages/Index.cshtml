@page "/home"
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}
@using budget_management_system_aspdotnetcore.Entities

<div class="container-fluid">

    @{
        var userRole = Model.userRole;
    }

    <!-- Budget Amendment History Card -->
    <div class="card mb-4 shadow-sm" style="border-radius: 10px;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 10px;">
                <h3 class="card-title">Budget Amendments</h3>

                @if (!String.Equals(userRole, "5"))
                {
                    <!-- Add New Amendment Main Button -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAmendmentMainModal">
                        Create New +
                    </button>
                }
            </div>

            <div class="d-flex align-items-end justify-content-between flex-wrap gap-3 mb-4">
                <!-- Financial Year Form -->
                <form method="get" class="d-flex align-items-end gap-3 flex-wrap">

                    <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                    <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                    <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />

                    <div>
                        <label for="financialYear" class="form-label mb-1">Financial year:</label>
                        <select class="form-select form-select-sm" id="financialYear" name="SelectedFinancialYear" onchange="toggleDateRange(this.value)">
                            @foreach (var fy in Model.FinancialYearOptions)
                            {
                                <option value="@fy" selected="@(fy == Model.SelectedFinancialYear ? "selected" : null)">@fy</option>
                            }
                        </select>
                    </div>

                    <div class="d-none" id="customDateRange">
                        <label class="form-label mb-1">From</label>
                        <input type="date" name="CustomStartDate" class="form-control form-control-sm" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="d-none" id="customDateRangeTo">
                        <label class="form-label mb-1">To</label>
                        <input type="date" name="CustomEndDate" class="form-control form-control-sm" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                    </div>

                    <div>
                        <button type="submit" class="btn btn-sm btn-outline-primary">Apply</button>
                    </div>
                </form>

                <!-- Submit Amendments Section -->
                <div class="text-end">
                    <label class="form-label d-block mb-1">Submit Drafts for Approval:</label>
                    <div class="d-flex align-items-end gap-2 flex-wrap justify-content-end">
                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="selectAllCategoryCheckboxes()">Select All</button>
                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="deselectAllCategoryCheckboxes()">Deselect All</button>

                        <form method="post" asp-page-handler="SubmitSelectedCategories" class="d-inline">
                            <input type="hidden" name="SelectedCategoryList" id="selectedCategoryList" />
                            <button type="submit" class="btn btn-sm btn-outline-primary" onclick="confirmAndSubmitCategories()" id="submitBtn" disabled>Submit</button>
                        </form>
                    </div>
                </div>
            </div>


            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-header">Total Amendments</div>
                        <div class="card-body">
                            <h5 class="card-title">@Model.OverviewTotalCount</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-header">Approved</div>
                        <div class="card-body">
                            <h5 class="card-title">@Model.OverviewApprovedCount</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-header">Pending</div>
                        <div class="card-body">
                            <h5 class="card-title">@Model.OverviewPendingCount</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger mb-3">
                        <div class="card-header">Rejected</div>
                        <div class="card-body">
                            <h5 class="card-title">@Model.OverviewRejectedCount</h5>
                        </div>
                    </div>
                </div>

                @if (!String.Equals(userRole, "5"))
                {
                    <div class="col-md-3">
                        <div class="card text-white bg-info mb-3 shadow-sm" style="border-radius: 12px;">
                            <div class="card-body">
                                <h5 class="card-title">Activity Summary</h5>
                                <p class="card-text mb-1"><strong>Total Actions:</strong> @Model.OverviewTotalActionsThisMonth</p>
                                <p class="card-text mb-1"><strong>Top User:</strong> @Model.OverviewMostActiveUser</p>
                                <p class="card-text"><strong>Last Action:</strong> @Model.OverviewLastActivityTime</p>
                            </div>
                        </div>
                    </div>
                }
            </div>



            <!-- Budget Amendments Section -->
            <div class="mb-4">
                <div class="accordion" id="budgetAmendmentsAccordion" >

                    @{
                        var baIndex = 0;
                        var userDepartmentsBA = Model.DepartmentsUserIsResponsibleFor;
                    }
                    @foreach (var amendmentmain in Model.BudgetAmendmentsMain)
                    {
                        var amendmentIndex = baIndex;
                        baIndex++;

                        <div class="accordion-item mb-3">
                            <h2 class="accordion-header" id="headingBA@(amendmentIndex)">
                                <button class="accordion-button collapsed py-4" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseBA@(amendmentIndex)"
                                        aria-expanded="false"
                                        aria-controls="collapseBA@(amendmentIndex)">
                                    <strong>@amendmentmain.Name - [@amendmentmain.StartDate.ToString("MM/dd/yyyy") to @amendmentmain.EndDate.ToString("MM/dd/yyyy")]</strong>
                                </button>
                            </h2>
                            <div id="collapseBA@(amendmentIndex)" class="accordion-collapse collapse"
                                 aria-labelledby="headingBA@(amendmentIndex)"
                                 data-bs-parent="#budgetAmendmentsAccordion"
                                 data-ba-id="@amendmentmain.BudgetAmendmentMainID">
                                <div class="accordion-body">
                                    <!-- Nested Accordion for Departments -->
                                    <div class="accordion" id="departmentsBA@(amendmentIndex)">

                                        @foreach (var dept in userDepartmentsBA)
                                        {
                                            var deptId = $"Dept{dept.DepartmentID}";

                                            <div class="accordion-item mb-2">
                                                <h2 class="accordion-header" id="heading@(deptId)BA@(amendmentIndex)">
                                                    <a href="@(Model.SelectedDepartmentID == dept.DepartmentID && Model.SelectedBudgetAmendmentMainID == amendmentmain.BudgetAmendmentMainID ? "javascript:void(0);" : $"?SelectedDepartmentID={dept.DepartmentID}&SelectedStatusTab={Model.SelectedStatusTab}&SelectedBudgetAmendmentMainID={amendmentmain.BudgetAmendmentMainID}&SelectedFinancialYear={Model.SelectedFinancialYear}&CustomStartDate={Model.CustomStartDate?.ToString("yyyy-MM-dd")}&CustomEndDate={Model.CustomEndDate?.ToString("yyyy-MM-dd")}")"
                                                       class="accordion-button @(Model.SelectedDepartmentID == dept.DepartmentID && Model.SelectedBudgetAmendmentMainID == amendmentmain.BudgetAmendmentMainID ? "" : "collapsed") py-3 text-decoration-none"
                                                       style="display: block;"
                                                    @Html.Raw(Model.SelectedDepartmentID == dept.DepartmentID && Model.SelectedBudgetAmendmentMainID == amendmentmain.BudgetAmendmentMainID ? $"data-bs-toggle=\"collapse\" data-bs-target=\"#collapse{deptId}BA{amendmentIndex}\"" : "")>
                                                        @dept.DepartmentName
                                                    </a>
                                                </h2>
                                                <div id="collapse@(deptId)BA@(amendmentIndex)" class="accordion-collapse collapse"
                                                     aria-labelledby="heading@(deptId)BA@(amendmentIndex)"
                                                     data-bs-parent="#departmentsBA@(amendmentIndex)"
                                                     data-dept-id="@dept.DepartmentID">

                                                    <div class="accordion-body">

                                                        <!-- Search Bar -->
                                                        <div class="d-flex gap-2 mb-3">
                                                            <form method="get" class="flex-grow-1">
                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                <div class="input-group">
                                                                    <input type="text" name="BudgetAmendmentSearchTerm" class="form-control" placeholder="Search..." value="@Model.BudgetAmendmentSearchTerm" />
                                                                    <button type="submit" class="btn btn-outline-secondary">Search</button>
                                                                </div>
                                                            </form>

                                                            @if (!String.Equals(userRole, "5"))
                                                            {
                                                                @if (Model.SelectedStatusTab != AmendmentStatus.Draft.ToString())
                                                                {
                                                                    <form method="post" asp-page-handler="ApproveCategory" onsubmit="return validateNetChange(this)">
                                                                        <button type="submit" disabled=@(Model.SelectedStatusTab != AmendmentStatus.Pending.ToString()) class="btn btn-link">Approve All ✔️</button>
                                                                    </form>

                                                                    <form method="post" asp-page-handler="RejectCategory">
                                                                        <button type="submit" disabled=@(Model.SelectedStatusTab != AmendmentStatus.Pending.ToString()) class="btn btn-link">Reject All ❌</button>
                                                                    </form>

                                                                    <form method="post" asp-page-handler="RevertCategory">
                                                                        <button type="submit" disabled=@(Model.SelectedStatusTab != AmendmentStatus.Approved.ToString() || Model.SelectedStatusTab != AmendmentStatus.Rejected.ToString()) class="btn btn-link text-nowrap">Revert Decision ↩️</button>
                                                                    </form>
                                                                }
                                                                else
                                                                {
                                                                    <form method="post" asp-page-handler="SubmitCategory">
                                                                        <button type="submit" class="btn btn-link text-nowrap">Submit Draft 🗒️</button>
                                                                    </form>

                                                                    <form method="post" asp-page-handler="WithdrawCategory">
                                                                        <button type="submit" class="btn btn-link text-nowrap">Withdraw ↩️</button>
                                                                    </form>
                                                                }

                                                                <button type="button" class="btn btn-link text-nowrap" data-bs-toggle="modal" data-bs-target="#extendDeadlineModal">
                                                                    Extend deadline ⌛
                                                                </button>
                                                                <div class="modal fade" id="extendDeadlineModal" tabindex="-1" aria-labelledby="extendDeadlineModalLabel" aria-hidden="true">
                                                                    <div class="modal-dialog">
                                                                        <div class="modal-content">
                                                                            <form method="post" asp-page-handler="ExtendDeadline">
                                                                                <div class="modal-header">
                                                                                    <h5 class="modal-title" id="extendDeadlineModalLabel">Extend Deadline</h5>
                                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                                </div>
                                                                                <div class="modal-body">
                                                                                    <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                    <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                    <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                    <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                    <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                    <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                    <div class="mb-3">
                                                                                        <label for="extensionDays" class="form-label">Extend deadline by additional day(s):</label>
                                                                                        <input type="number" class="form-control" id="extensionDays" name="extensionDays" min="1" required />
                                                                                    </div>
                                                                                    <p class="text-muted">This will extend the deadline for all visible records in the current view.</p>
                                                                                </div>
                                                                                <div class="modal-footer">
                                                                                    <button type="submit" class="btn btn-primary">Submit</button>
                                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }

                                                            <button type="button" class="btn btn-primary flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addAmendmentModal"
                                                                    @(DateTime.Now < Model.BudgetAmendmentMainStartDate || DateTime.Now > Model.BudgetAmendmentMainEndDate ? "disabled" : "")>
                                                                Create New +
                                                            </button>

@*                                                             @if (!String.Equals(userRole, "5"))
                                                            {
                                                                if (categoryGroup.Any(a => a.Status.ToString().Equals("Approved")) || categoryGroup.Any(a => a.Status.ToString().Equals("Rejected")))
                                                                {
                                                                    <td colspan="2">
                                                                        <form method="post" asp-page-handler="RevertCategory" asp-route-category="@categoryGroup.Key">
                                                                            <button type="submit" class="btn btn-link text-nowrap">Revert Decision ↩️</button>
                                                                        </form>
                                                                    </td>
                                                                }
                                                                else if (categoryGroup.Any(a => a.Status.ToString().Equals("Draft")))
                                                                {
                                                                    <td colspan="2">
                                                                        <form method="post" asp-page-handler="SubmitCategory" asp-route-category="@categoryGroup.Key">
                                                                            <button type="submit" class="btn btn-link text-nowrap">Submit Draft<br /> 🗒️</button>
                                                                        </form>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td colspan="2">
                                                                        <div class="d-flex justify-content-evenly gap-2">
                                                                            <form method="post" asp-page-handler="ApproveCategory" asp-route-category="@categoryGroup.Key" onsubmit="return validateNetChange(this)">
                                                                                <input type="hidden" name="NetChange" value="@netChange" />
                                                                                <button type="submit" disabled=@(!categoryGroup.Any(a => a.Status.ToString().Equals("Pending"))) class="btn btn-link">Approve ✔️</button>
                                                                            </form>

                                                                            <form method="post" asp-page-handler="RejectCategory" asp-route-category="@categoryGroup.Key">
                                                                                <button type="submit" disabled=@(!categoryGroup.Any(a => a.Status.ToString().Equals("Pending"))) class="btn btn-link">Reject ❌</button>
                                                                            </form>
                                                                        </div>
                                                                    </td>
                                                                }
                                                            }

                                                            else
                                                            {
                                                                if (categoryGroup.Any(a => a.Status.ToString().Equals("Pending")))
                                                                {
                                                                    <td colspan="2">
                                                                        <form method="post" asp-page-handler="WithdrawCategory" asp-route-category="@categoryGroup.Key">
                                                                            <button type="submit" class="btn btn-link text-nowrap">Withdraw</button>
                                                                        </form>
                                                                    </td>
                                                                }
                                                                else if (categoryGroup.Any(a => a.Status.ToString().Equals("Draft")))
                                                                {
                                                                    <td colspan="2">
                                                                        <form method="post" asp-page-handler="SubmitCategory" asp-route-category="@categoryGroup.Key">
                                                                            <button type="submit" class="btn btn-link text-nowrap">Submit Draft</button>
                                                                        </form>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td colspan="2">
                                                                    </td>
                                                                }
                                                            } *@

                                                        </div>

                                                        <!-- Status Tabs for this department -->
                                                        <ul class="nav nav-tabs justify-content-center mb-3">
                                                            @{
                                                                var statusNames = Enum.GetNames(typeof(budget_management_system_aspdotnetcore.Entities.AmendmentStatus));
                                                            }
                                                            @foreach (var status in statusNames)
                                                            {
                                                                var isActive = Model.SelectedStatusTab == status ? "active" : "";
                                                                <li class="nav-item">
                                                                    <a class="nav-link @isActive"
                                                                       href="?SelectedDepartmentID=@dept.DepartmentID&SelectedStatusTab=@status&SelectedBudgetAmendmentMainID=@amendmentmain.BudgetAmendmentMainID&SelectedFinancialYear=@Model.SelectedFinancialYear&CustomStartDate=@Model.CustomStartDate?.ToString("yyyy-MM-dd")&CustomEndDate=@Model.CustomEndDate?.ToString("yyyy-MM-dd")">@status</a>
                                                                </li>
                                                            }
                                                            @{
                                                                var isAllActive = string.IsNullOrEmpty(Model.SelectedStatusTab) ? "active" : "";
                                                            }
                                                            <li class="nav-item">
                                                                <a class="nav-link @isAllActive"
                                                                   href="?SelectedDepartmentID=@dept.DepartmentID&SelectedStatusTab=&SelectedBudgetAmendmentMainID=@amendmentmain.BudgetAmendmentMainID&SelectedFinancialYear=@Model.SelectedFinancialYear&CustomStartDate=@Model.CustomStartDate?.ToString("yyyy-MM-dd")&CustomEndDate=@Model.CustomEndDate?.ToString("yyyy-MM-dd")">All</a>
                                                            </li>
                                                        </ul>

                                                        <div class="table-responsive">
                                                            <table class="table table-bordered table-striped table-hover text-center">
                                                                <thead>
                                                                    <tr>
                                                                        <th>
                                                                            Amendment ID
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="BudgetAmendmentID" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("BudgetAmendmentID")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("BudgetAmendmentID")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Category Name
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="CategoryName" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("CategoryName")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("CategoryName")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Adjustment Detail
                                                                        </th>
                                                                        <th>
                                                                            SpeedType
                                                                        </th>
                                                                        <th>
                                                                            Fund Code
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="FundCode" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("FundCode")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("FundCode")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Department ID
                                                                        </th>
                                                                        <th>
                                                                            Program Code
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="ProgramCode" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("ProgramCode")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("ProgramCode")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Class Code
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="ClassCode" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("ClassCode")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("ClassCode")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Acct Description
                                                                        </th>
                                                                        <th>
                                                                            Budget Code
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="BudgetCode" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("BudgetCode")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("BudgetCode")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Position Number
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="PositionNumber" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("PositionNumber")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("PositionNumber")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Amount Increase
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="AmountIncrease" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("AmountIncrease")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("AmountIncrease")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Amount Decrease
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="AmountDecrease" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("AmountDecrease")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("AmountDecrease")"></i>
                                                                                </button>
                                                                            </form>
                                                                        </th>
                                                                        <th>
                                                                            Created By
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="CreatedBy" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("CreatedBy")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("CreatedBy")"></i>
                                                                                </button>
                                                                            </form>

                                                                            <div class="dropdown d-inline">
                                                                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="createdByFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                                                    <i class="fas fa-filter"></i>
                                                                                </button>

                                                                                <div class="dropdown-menu p-3 shadow-lg" style="min-width: 250px;">
                                                                                    <form method="get">
                                                                                        <!-- Creator Dropdown -->
                                                                                        <div class="mb-2">
                                                                                            <label for="SelectedCreatedBy" class="form-label">Created By</label>
                                                                                            <select name="SelectedCreatedBy" class="form-select form-select-sm">
                                                                                                <option value="">Any</option>
                                                                                                @foreach (var user in Model.CreatedByUsers)
                                                                                                {
                                                                                                    <option value="@user.Value" selected="@(Model.SelectedCreatedBy?.ToString() == user.Value)">
                                                                                                        @user.Text
                                                                                                    </option>
                                                                                                }
                                                                                            </select>
                                                                                        </div>

                                                                                        <!-- Date Range -->
                                                                                        <div class="mb-2">
                                                                                            <label class="form-label">From</label>
                                                                                            <input type="date" name="CreatedFromDate" class="form-control form-control-sm" min="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" max="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" value="@Model.CreatedFromDate?.ToString("yyyy-MM-dd")" />
                                                                                        </div>
                                                                                        <div class="mb-2">
                                                                                            <label class="form-label">To</label>
                                                                                            <input type="date" name="CreatedToDate" class="form-control form-control-sm" min="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" max="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" value="@Model.CreatedToDate?.ToString("yyyy-MM-dd")" />
                                                                                        </div>

                                                                                        <!-- Apply Button -->
                                                                                        <div class="text-end mt-2">
                                                                                            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                                                                                        </div>
                                                                                    </form>
                                                                                </div>
                                                                            </div>
                                                                        </th>

                                                                        <th>
                                                                            Edited By
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="EditedBy" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("EditedBy")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("EditedBy")"></i>
                                                                                </button>
                                                                            </form>

                                                                            <div class="dropdown d-inline">
                                                                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="editedByFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                                                    <i class="fas fa-filter"></i>
                                                                                </button>

                                                                                <div class="dropdown-menu p-3 shadow-lg" style="min-width: 250px;">
                                                                                    <form method="get">
                                                                                        <!-- Editor Dropdown -->
                                                                                        <div class="mb-2">
                                                                                            <label for="SelectedEditedBy" class="form-label">Edited By</label>
                                                                                            <select name="SelectedEditedBy" class="form-select form-select-sm">
                                                                                                <option value="">Any</option>
                                                                                                @foreach (var user in Model.EditedByUsers)
                                                                                                {
                                                                                                    <option value="@user.Value" selected="@(Model.SelectedEditedBy?.ToString() == user.Value)">
                                                                                                        @user.Text
                                                                                                    </option>
                                                                                                }
                                                                                            </select>
                                                                                        </div>

                                                                                        <!-- Date Range -->
                                                                                        <div class="mb-2">
                                                                                            <label class="form-label">From</label>
                                                                                            <input type="date" name="EditedFromDate" class="form-control form-control-sm" min="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" value="@Model.EditedFromDate?.ToString("yyyy-MM-dd")" />
                                                                                        </div>
                                                                                        <div class="mb-2">
                                                                                            <label class="form-label">To</label>
                                                                                            <input type="date" name="EditedToDate" class="form-control form-control-sm" min="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" value="@Model.EditedToDate?.ToString("yyyy-MM-dd")" />
                                                                                        </div>

                                                                                        <!-- Apply Button -->
                                                                                        <div class="text-end mt-2">
                                                                                            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                                                                                        </div>
                                                                                    </form>
                                                                                </div>
                                                                            </div>
                                                                        </th>

                                                                        <th>
                                                                            Updated By
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="UpdatedBy" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("UpdatedBy")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                <button type="submit" class="btn btn-link p-0">
                                                                                    <i class="fas @Model.GetSortIcon("UpdatedBy")"></i>
                                                                                </button>
                                                                            </form>

                                                                            <div class="dropdown d-inline">
                                                                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="updatedByFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                                                    <i class="fas fa-filter"></i>
                                                                                </button>

                                                                                <div class="dropdown-menu p-3 shadow-lg" style="min-width: 250px;">
                                                                                    <form method="get">
                                                                                        <!-- Updater Dropdown -->
                                                                                        <div class="mb-2">
                                                                                            <label for="SelectedUpdatedBy" class="form-label">Updated By</label>
                                                                                            <select name="SelectedUpdatedBy" class="form-select form-select-sm">
                                                                                                <option value="">Any</option>
                                                                                                @foreach (var user in Model.UpdatedByUsers)
                                                                                                {
                                                                                                    <option value="@user.Value" selected="@(Model.SelectedUpdatedBy?.ToString() == user.Value)">
                                                                                                        @user.Text
                                                                                                    </option>
                                                                                                }
                                                                                            </select>
                                                                                        </div>

                                                                                        <!-- Date Range -->
                                                                                        <div class="mb-2">
                                                                                            <label class="form-label">From</label>
                                                                                            <input type="date" name="UpdatedFromDate" class="form-control form-control-sm" min="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" value="@Model.UpdatedFromDate?.ToString("yyyy-MM-dd")" />
                                                                                        </div>
                                                                                        <div class="mb-2">
                                                                                            <label class="form-label">To</label>
                                                                                            <input type="date" name="UpdatedToDate" class="form-control form-control-sm" min="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" value="@Model.UpdatedToDate?.ToString("yyyy-MM-dd")" />
                                                                                        </div>

                                                                                        <!-- Apply Button -->
                                                                                        <div class="text-end mt-2">
                                                                                            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                                                                                        </div>
                                                                                    </form>
                                                                                </div>
                                                                            </div>
                                                                        </th>
                                                                        <th>
                                                                            Start Date
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="StartDate" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("StartDate")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                            </form>
                                                                            <div class="dropdown d-inline">
                                                                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                                                    <i class="fas fa-filter"></i>
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                        <th>
                                                                            Deadline
                                                                            <form method="get" class="d-inline">
                                                                                <input type="hidden" name="handler" value="SortColumn" />
                                                                                <input type="hidden" name="table" value="AmendmentHistory" />
                                                                                <input type="hidden" name="column" value="Deadline" />
                                                                                <input type="hidden" name="order" value="@Model.SortOrderForColumn("Deadline")" />
                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                            </form>
                                                                            <div class="dropdown d-inline">
                                                                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                                                    <i class="fas fa-filter"></i>
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                        <th>
                                                                            Extension (Days)
                                                                        </th>
                                                                        <th>
                                                                            Status
                                                                        </th>
                                                                        <th colspan="4">Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @if (!Model.BudgetAmendments.Any())
                                                                    {
                                                                        <tr>
                                                                            <td colspan="23" class="text-center py-5">
                                                                                <div class="py-5">
                                                                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                                                    <p class="text-muted mb-0">No records found</p>
                                                                                    <small class="text-muted">Try adjusting your filters or create a new amendment</small>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                    @foreach (var categoryGroup in Model.BudgetAmendments.GroupBy(a => a.CategoryName))
                                                                    {
                                                                        var totalIncrease = categoryGroup.Sum(a => a.AmountIncrease);
                                                                        var totalDecrease = categoryGroup.Sum(a => a.AmountDecrease);

                                                                        <!-- Submit checkbox: enabled only if all amendments in this category are Drafts -->
                                                                        <tr class="table-primary align-middle">

                                                                            <td colspan="1">
                                                                                @{
                                                                                    var allApproved = categoryGroup.All(a => a.Status.ToString().Equals("Draft"));
                                                                                    var checkboxId = $"submitCheckbox_{categoryGroup.Key.Replace(" ", "_")}";
                                                                                }
                                                                                <div class="form-check">
                                                                                    <input class="form-check-input category-submit-checkbox"
                                                                                           type="checkbox"
                                                                                           name="SelectedCategories"
                                                                                           value="@categoryGroup.Key"
                                                                                           id="@checkboxId"
                                                                                           @(allApproved ? "" : "disabled") />
                                                                                    <label class="form-check-label" for="@checkboxId">
                                                                                    </label>
                                                                                </div>
                                                                            </td>

                                                                            <td colspan="1"><strong>@categoryGroup.Key</strong></td>

                                                                            @{
                                                                                var netChange = totalIncrease - totalDecrease;
                                                                                var cellClass = netChange == 0 ? "text-success" : "text-danger";
                                                                            }
                                                                            <td colspan="9"></td>
                                                                            <td colspan="2" class="@cellClass">$@netChange</td>
                                                                            <td colspan="7"></td>

                                                                            @if (!String.Equals(userRole, "5"))
                                                                            {
                                                                                if (categoryGroup.Any(a => a.Status.ToString().Equals("Approved")) || categoryGroup.Any(a => a.Status.ToString().Equals("Rejected")))
                                                                                {
                                                                                    <td colspan="2">
                                                                                        <form method="post" asp-page-handler="RevertCategory" asp-route-category="@categoryGroup.Key">
                                                                                            <button type="submit" class="btn btn-link text-nowrap">Revert Decision ↩️</button>
                                                                                        </form>
                                                                                    </td>
                                                                                }
                                                                                else if (categoryGroup.Any(a => a.Status.ToString().Equals("Draft")))
                                                                                {
                                                                                    <td colspan="2">
                                                                                        <form method="post" asp-page-handler="SubmitCategory" asp-route-category="@categoryGroup.Key">
                                                                                            <button type="submit" class="btn btn-link text-nowrap">Submit Draft<br /> 🗒️</button>
                                                                                        </form>
                                                                                    </td>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <td colspan="2">
                                                                                        <div class="d-flex justify-content-evenly gap-2">
                                                                                            <form method="post" asp-page-handler="ApproveCategory" asp-route-category="@categoryGroup.Key" onsubmit="return validateNetChange(this)">
                                                                                                <input type="hidden" name="NetChange" value="@netChange" />
                                                                                                <button type="submit" disabled=@(!categoryGroup.Any(a => a.Status.ToString().Equals("Pending"))) class="btn btn-link">Approve ✔️</button>
                                                                                            </form>

                                                                                            <form method="post" asp-page-handler="RejectCategory" asp-route-category="@categoryGroup.Key">
                                                                                                <button type="submit" disabled=@(!categoryGroup.Any(a => a.Status.ToString().Equals("Pending"))) class="btn btn-link">Reject ❌</button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </td>
                                                                                }
                                                                            }

                                                                            else
                                                                            {
                                                                                if (categoryGroup.Any(a => a.Status.ToString().Equals("Pending")))
                                                                                {
                                                                                    <td colspan="2">
                                                                                        <form method="post" asp-page-handler="WithdrawCategory" asp-route-category="@categoryGroup.Key">
                                                                                            <button type="submit" class="btn btn-link text-nowrap">Withdraw</button>
                                                                                        </form>
                                                                                    </td>
                                                                                }
                                                                                else if (categoryGroup.Any(a => a.Status.ToString().Equals("Draft")))
                                                                                {
                                                                                    <td colspan="2">
                                                                                        <form method="post" asp-page-handler="SubmitCategory" asp-route-category="@categoryGroup.Key">
                                                                                            <button type="submit" class="btn btn-link text-nowrap">Submit Draft</button>
                                                                                        </form>
                                                                                    </td>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <td colspan="2">
                                                                                    </td>
                                                                                }
                                                                            }
                                                                        </tr>

                                                                        @foreach (var amendment in categoryGroup)
                                                                        {
                                                                            if (Model.EditingBudgetAmendmentID == amendment.BudgetAmendmentID)
                                                                            {
                                                                                <tr>
                                                                                    <form method="post" asp-page-handler="SaveAmendment" asp-route-id="@amendment.BudgetAmendmentID">
                                                                                    <td><input asp-for="NewBudgetAmendment.BudgetAmendmentID" value="@amendment.BudgetAmendmentID" class="form-control" readonly /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.CategoryName" value="@amendment.CategoryName" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.AdjustmentDetail" value="@amendment.AdjustmentDetail" class="form-control" /></td>
                                                                                    <td>@amendment.SpeedType.Code</td>
                                                                                    <input asp-for="@Model.SourceSpeedtype" type="hidden" value="@Model.SourceSpeedtype" />
                                                                                    <input asp-for="@Model.DestinationSpeedtype" type="hidden" value="@Model.DestinationSpeedtype" />
                                                                                    <td><input asp-for="NewBudgetAmendment.FundCode" value="@amendment.FundCode" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.DepartmentID" value="@amendment.DepartmentID" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.ProgramCode" value="@amendment.ProgramCode" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.ClassCode" value="@amendment.ClassCode" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.AcctDescription" value="@amendment.AcctDescription" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.BudgetCode" value="@amendment.BudgetCode" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.PositionNumber" value="@amendment.PositionNumber" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.AmountIncrease" value="@amendment.AmountIncrease" class="form-control" /></td>
                                                                                    <td><input asp-for="NewBudgetAmendment.AmountDecrease" value="@amendment.AmountDecrease" class="form-control" /></td>
                                                                                    <td>@(amendment.CreatedByUser?.Email ?? "N/A") <br> at <br> @(amendment.CreatedAt?.ToString("MM/dd/yy HH:mm") ?? "N/A")</td>
                                                                                    <td>@(amendment.EditedByUser?.Email ?? "N/A") <br> at <br> @(amendment.EditedAt?.ToString("MM/dd/yy HH:mm") ?? "N/A")</td>
                                                                                    <td>@(amendment.UpdatedByUser?.Email ?? "N/A") <br> at <br> @(amendment.UpdatedAt?.ToString("MM/dd/yy HH:mm") ?? "N/A")</td>
                                                                                    <td>@amendment.StartDate</td>
                                                                                    <td>@amendment.Deadline</td>
                                                                                    <td>@amendment.ExtensionDays</td>
                                                                                    @{
                                                                                        var isApproved = amendment.Status == AmendmentStatus.Approved;
                                                                                        var statusClass = isApproved ? "text-primary" : "";

                                                                                        switch (amendment.Status)
                                                                                        {
                                                                                            case AmendmentStatus.Approved:
                                                                                                statusClass = "text-success";
                                                                                                break;
                                                                                            case AmendmentStatus.Rejected:
                                                                                                statusClass = "text-danger";
                                                                                                break;
                                                                                            case AmendmentStatus.Draft:
                                                                                                statusClass = "text-primary";
                                                                                                break;
                                                                                            default:
                                                                                                statusClass = "";
                                                                                                break;
                                                                                        }
                                                                                    }
                                                                                    <td class="@statusClass">@amendment.Status</td>
                                                                                    <td>
                                                                                        <div class="d-flex justify-content-evenly gap-2">
                                                                                            <button type="submit" class="btn btn-success">Save</button>
                                                                                            <form method="post" asp-page-handler="CancelEditAmendment" asp-route-id="@amendment.BudgetAmendmentID">
                                                                                                <button type="submit" class="btn btn-secondary">Cancel</button>
                                                                                            </form>

                                                                                        </div>
                                                                                    </td>
                                                                                    </form>
                                                                                </tr>
                                                                            }
                                                                            else
                                                                            {
                                                                                <tr>
                                                                                    <td>@amendment.BudgetAmendmentID</td>
                                                                                    <td>@amendment.CategoryName</td>
                                                                                    <td>@amendment.AdjustmentDetail</td>
                                                                                    <td>@amendment.SpeedType.Code</td>
                                                                                    <td>@amendment.FundCode</td>
                                                                                    <td>@amendment.DepartmentID</td>
                                                                                    <td>@amendment.ProgramCode</td>
                                                                                    <td>@amendment.ClassCode</td>
                                                                                    <td>@amendment.AcctDescription</td>
                                                                                    <td>@amendment.BudgetCode</td>
                                                                                    <td>@amendment.PositionNumber</td>
                                                                                    <td>@amendment.AmountIncrease</td>
                                                                                    <td>@amendment.AmountDecrease</td>
                                                                                    <td>@(amendment.CreatedByUser?.Email ?? "N/A") <br> at <br> @(amendment.CreatedAt?.ToString("MM/dd/yy HH:mm") ?? "N/A")</td>
                                                                                    <td>@(amendment.EditedByUser?.Email ?? "N/A") <br> at <br> @(amendment.EditedAt?.ToString("MM/dd/yy HH:mm") ?? "N/A")</td>
                                                                                    <td>@(amendment.UpdatedByUser?.Email ?? "N/A") <br> at <br> @(amendment.UpdatedAt?.ToString("MM/dd/yy HH:mm") ?? "N/A")</td>
                                                                                    <td>@amendment.StartDate</td>
                                                                                    <td>@amendment.Deadline</td>
                                                                                    <td>@amendment.ExtensionDays</td>
                                                                                    @{
                                                                                        var isApproved = amendment.Status == AmendmentStatus.Approved;
                                                                                        var statusClass = isApproved ? "text-primary" : "";

                                                                                        switch (amendment.Status)
                                                                                        {
                                                                                            case AmendmentStatus.Approved:
                                                                                                statusClass = "text-success";
                                                                                                break;
                                                                                            case AmendmentStatus.Rejected:
                                                                                                statusClass = "text-danger";
                                                                                                break;
                                                                                            case AmendmentStatus.Draft:
                                                                                                statusClass = "text-primary";
                                                                                                break;
                                                                                            default:
                                                                                                statusClass = "";
                                                                                                break;
                                                                                        }
                                                                                    }
                                                                                    <td class="@statusClass">@amendment.Status</td>
                                                                                    <td colspan="4">
                                                                                        @{
                                                                                            var isEnabled = false;
                                                                                            if (!String.Equals(userRole, "5") && (amendment.Status.ToString().Equals("Draft") || amendment.Status.ToString().Equals("Pending")))
                                                                                            {
                                                                                                isEnabled = true;
                                                                                            }
                                                                                            else if (String.Equals(userRole, "5") && (amendment.Status.ToString().Equals("Draft")))
                                                                                            {
                                                                                                isEnabled = true;
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                isEnabled = false;
                                                                                            }
                                                                                        }
                                                                                        <div class="d-flex justify-content-evenly gap-2">
                                                                                            <form method="post" asp-page-handler="EditAmendment" asp-route-id="@amendment.BudgetAmendmentID">
                                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                                <button type="submit" disabled=@(!isEnabled) class="btn btn-outline-secondary">Edit</button>
                                                                                            </form>
                                                                                            <form method="post" asp-page-handler="DeleteAmendment" asp-route-id="@amendment.BudgetAmendmentID">
                                                                                                <input type="hidden" name="SelectedDepartmentID" value="@Model.SelectedDepartmentID" />
                                                                                                <input type="hidden" name="SelectedStatusTab" value="@Model.SelectedStatusTab" />
                                                                                                <input type="hidden" name="SelectedBudgetAmendmentMainID" value="@Model.SelectedBudgetAmendmentMainID" />
                                                                                                <input type="hidden" name="SelectedFinancialYear" value="@Model.SelectedFinancialYear" />
                                                                                                <input type="hidden" name="CustomStartDate" value="@Model.CustomStartDate?.ToString("yyyy-MM-dd")" />
                                                                                                <input type="hidden" name="CustomEndDate" value="@Model.CustomEndDate?.ToString("yyyy-MM-dd")" />
                                                                                                <button type="submit" disabled=@(!isEnabled) class="btn btn-outline-danger">Delete</button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            }
                                                                        }
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>

                                                        <!-- Pagination Controls -->
                                                        <nav class="d-flex justify-content-between align-items-center my-3" aria-label="Budget Amendment Page navigation">
                                                            <!-- Results per page dropdown on the left -->
                                                            <div class="d-flex align-items-center">
                                                                <label for="resultsPerPage" class="me-2">Results per page:</label>
                                                                <select id="resultsPerPage" class="form-select me-3" style="width: auto;"
                                                                        onchange="window.location.href = '?amendmentPageNumber=1&amendmentsPerPage=' + this.value + '&SelectedDepartmentID=@Model.SelectedDepartmentID&SelectedStatusTab=@Model.SelectedStatusTab&SelectedBudgetAmendmentMainID=@Model.SelectedBudgetAmendmentMainID&SelectedFinancialYear=@Model.SelectedFinancialYear&CustomStartDate=@Model.CustomStartDate?.ToString("yyyy-MM-dd")&CustomEndDate=@Model.CustomEndDate?.ToString("yyyy-MM-dd")'">
                                                                    @foreach (var size in Model.PageSizes)
                                                                    {
                                                                        <option value="@size" selected="@(Model.BudgetAmendmentResultsPerPage == size ? "selected" : null)">@size</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                            @{
                                                                int amendmentRecordsShown = Math.Min(Model.BudgetAmendmentResultsPerPage, Model.TotalBudgetAmendments - ((Model.BudgetAmendmentCurrentPage - 1) * Model.BudgetAmendmentResultsPerPage));
                                                            }
                                                            <span>Records: @amendmentRecordsShown of @Model.TotalBudgetAmendments</span>
                                                            <ul class="pagination mb-0">
                                                                <li class="page-item @(Model.BudgetAmendmentCurrentPage <= 1 ? "disabled" : "")">
                                                                    <a class="page-link" href="?amendmentPageNumber=@(Model.BudgetAmendmentCurrentPage - 1)&amendmentsPerPage=@Model.BudgetAmendmentResultsPerPage&SelectedDepartmentID=@Model.SelectedDepartmentID&SelectedStatusTab=@Model.SelectedStatusTab&SelectedBudgetAmendmentMainID=@Model.SelectedBudgetAmendmentMainID&SelectedFinancialYear=@Model.SelectedFinancialYear&CustomStartDate=@Model.CustomStartDate?.ToString("yyyy-MM-dd")&CustomEndDate=@Model.CustomEndDate?.ToString("yyyy-MM-dd")"
                                                                       aria-label="Previous">
                                                                        <span aria-hidden="true">&laquo;</span>
                                                                    </a>
                                                                </li>
                                                                <li class="page-item active">
                                                                    <span class="page-link">@Model.BudgetAmendmentCurrentPage</span>
                                                                </li>
                                                                <li class="page-item @(Model.BudgetAmendmentCurrentPage >= Model.BudgetAmendmentTotalPages ? "disabled" : "")">
                                                                    <a class="page-link" href="?amendmentPageNumber=@(Model.BudgetAmendmentCurrentPage + 1)&amendmentsPerPage=@Model.BudgetAmendmentResultsPerPage&SelectedDepartmentID=@Model.SelectedDepartmentID&SelectedStatusTab=@Model.SelectedStatusTab&SelectedBudgetAmendmentMainID=@Model.SelectedBudgetAmendmentMainID&SelectedFinancialYear=@Model.SelectedFinancialYear&CustomStartDate=@Model.CustomStartDate?.ToString("yyyy-MM-dd")&CustomEndDate=@Model.CustomEndDate?.ToString("yyyy-MM-dd")"
                                                                       aria-label="Next">
                                                                        <span aria-hidden="true">&raquo;</span>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </nav>

                                                    </div>
                                                </div>
                                            </div>
                                        }

                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                </div>
            </div>

            <form method="post" asp-page-handler="ExportToExcelBudgetAmendments">
                <button type="submit" class="btn btn-success">
                    Export to XLS
                </button>
            </form>
        </div>
    </div>

    <!-- Add Budget Amendment Main Modal -->
    <div class="modal fade" id="addAmendmentMainModal" tabindex="-1" aria-labelledby="addAmendmentMainModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAmendmentMainModalLabel">Create New Budget Amendment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-page-handler="AddAmendmentMain" id="addBudgetAmendmentForm">
                        <div class="mb-3">
                            <label asp-for="NewBudgetAmendmentMain.Name" class="form-label">Budget Amendment Name</label>
                            <input asp-for="NewBudgetAmendmentMain.Name" class="form-control" placeholder="e.g., BA#4" required />
                        </div>
                        <div class="mb-3">
                            <label asp-for="NewBudgetAmendmentMain.StartDate" class="form-label">Start Date</label>
                            <input asp-for="NewBudgetAmendmentMain.StartDate" type="date" class="form-control" id="startDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                        </div>
                        <div class="mb-3">
                            <label asp-for="NewBudgetAmendmentMain.EndDate" class="form-label">End Date</label>
                            <input asp-for="NewBudgetAmendmentMain.EndDate" type="date" class="form-control" id="endDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                            <div class="invalid-feedback" id="dateError">End date must be after start date.</div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Create</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Budget Amendment Modal -->
    <div class="modal fade" id="addAmendmentModal" tabindex="-1" aria-labelledby="addAmendmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAmendmentModalLabel">Create New Budget Amendment Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-page-handler="AddAmendment">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.CategoryName" class="form-label">Category Name</label>
                                <input asp-for="NewBudgetAmendment.CategoryName" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.AdjustmentDetail" class="form-label">Adjustment Detail</label>
                                <input asp-for="NewBudgetAmendment.AdjustmentDetail" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3 d-flex flex-column">
                                <label asp-for="SourceSpeedtype" class="form-label">Source SpeedType</label>
                                <select asp-for="SourceSpeedtype" class="selectpicker w-100" data-live-search="true" id="sourceSpeedtype">
                                    @foreach (var speedtype in Model.SpeedTypes)
                                    {
                                        <option value="@speedtype.SpeedTypeId" data-tokens="@speedtype.Code" data-fundcode="@speedtype.FundCode" data-programcode="@speedtype.ProgramCode" data-classcode="@speedtype.ClassCode">
                                            @speedtype.Code
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3 d-flex flex-column">
                                <label asp-for="DestinationSpeedtype" class="form-label">Destination SpeedType</label>
                                <select asp-for="DestinationSpeedtype" class="selectpicker w-100" data-live-search="true">
                                    @foreach (var speedtype in Model.SpeedTypes)
                                    {
                                        <option value="@speedtype.SpeedTypeId" data-tokens="@speedtype.Code">
                                            @speedtype.Code
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.FundCode" class="form-label">Fund Code</label>
                                <input asp-for="NewBudgetAmendment.FundCode" class="form-control" id="fundCode" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.DepartmentID" class="form-label">Department ID</label>
                                <input asp-for="NewBudgetAmendment.DepartmentID" class="form-control" value="@Model.SelectedDepartmentID" readonly />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.ProgramCode" class="form-label">Program Code</label>
                                <input asp-for="NewBudgetAmendment.ProgramCode" class="form-control" id="programCode" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.ClassCode" class="form-label">Class Code</label>
                                <input asp-for="NewBudgetAmendment.ClassCode" class="form-control" id="classCode" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.AcctDescription" class="form-label">Account Description</label>
                                <input asp-for="NewBudgetAmendment.AcctDescription" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.BudgetCode" class="form-label">Budget Code</label>
                                <input asp-for="NewBudgetAmendment.BudgetCode" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="NewBudgetAmendment.PositionNumber" class="form-label">Position Number</label>
                                <input asp-for="NewBudgetAmendment.PositionNumber" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="TransferAmount" class="form-label">Amount</label>
                                <input asp-for="TransferAmount" class="form-control" type="number" step="0.01" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Create Draft</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}

    <script>

        window.addEventListener('beforeunload', function () {
            sessionStorage.setItem('scrollPosition', window.scrollY);
        });

        document.addEventListener('DOMContentLoaded', function () {

        const scrollPosition = sessionStorage.getItem('scrollPosition');
        if (scrollPosition) {
            window.scrollTo(0, parseInt(scrollPosition));
            sessionStorage.removeItem('scrollPosition');
        }

            const urlParams = new URLSearchParams(window.location.search);
            const selectedBA = urlParams.get('SelectedBudgetAmendmentMainID');
            const selectedDept = urlParams.get('SelectedDepartmentID');

            if (selectedBA && selectedDept) {
                // Find and open the budget amendment 

                const baAccordions = document.querySelectorAll('[id^="collapseBA"]');
                baAccordions.forEach(accordion => {
                    if (accordion.getAttribute('data-ba-id') == selectedBA) {
                        new bootstrap.Collapse(accordion, { show: true });

                        // Wait for parent to open, then open department
                        setTimeout(() => {
                            const deptAccordions = accordion.querySelectorAll('[data-dept-id]');
                            deptAccordions.forEach(deptAccordion => {
                                if (deptAccordion.getAttribute('data-dept-id') == selectedDept) {
                                    new bootstrap.Collapse(deptAccordion, { show: true });
                                }
                            });
                        }, 350);
                    }
                });
            }
        });

    document.getElementById('addBudgetAmendmentForm').addEventListener('submit', function (e) {
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);
        const dateError = document.getElementById('dateError');
        const endDateInput = document.getElementById('endDate');

        if (startDate >= endDate) {
            e.preventDefault();
            endDateInput.classList.add('is-invalid');
            dateError.style.display = 'block';
        } else {
            endDateInput.classList.remove('is-invalid');
            dateError.style.display = 'none';
        }
    });

    // Clear error on input change
    document.getElementById('endDate').addEventListener('change', function () {
        this.classList.remove('is-invalid');
        document.getElementById('dateError').style.display = 'none';
    });
    document.getElementById('startDate').addEventListener('change', function () {
        document.getElementById('endDate').classList.remove('is-invalid');
        document.getElementById('dateError').style.display = 'none';
    });


        function selectAllCategoryCheckboxes() {
            document.querySelectorAll('.category-submit-checkbox:not(:disabled)').forEach(cb => cb.checked = true);
        }

        function deselectAllCategoryCheckboxes() {
            document.querySelectorAll('.category-submit-checkbox').forEach(cb => cb.checked = false);
        }

        function confirmAndSubmitCategories() {
            const selected = Array.from(document.querySelectorAll(".category-submit-checkbox:checked"))
                .filter(cb => !cb.disabled);

            if (selected.length === 0) {
                alert("Please select at least one category to submit.");
                return;
            }

            const confirmSubmit = confirm(`Are you sure you want to submit ${selected.length} selected amendment${selected.length > 1 ? 's' : ''} for approval?`);

            if (confirmSubmit) {
                prepareSelectedCategories();

                document.querySelector('form[method="post"][asp-page-handler="SubmitSelectedCategories"]').submit();
            }
        }

        function prepareSelectedCategories() {
            const selected = Array.from(document.querySelectorAll(".category-submit-checkbox:checked"))
                .filter(cb => !cb.disabled)
                .map(cb => cb.value);

            document.getElementById("selectedCategoryList").value = selected.join(",");
        }

        function toggleDateRange(selectedValue) {
            const isCustom = selectedValue === "Custom";
            document.getElementById("customDateRange").classList.toggle("d-none", !isCustom);
            document.getElementById("customDateRangeTo").classList.toggle("d-none", !isCustom);
        }

        document.addEventListener("DOMContentLoaded", function () {
            toggleDateRange(document.getElementById("financialYear").value);
        });

        document.addEventListener("DOMContentLoaded", function () {
            const submitBtn = document.getElementById("submitBtn");
            const checkboxes = document.querySelectorAll(".category-submit-checkbox");

            function updateSubmitButtonState() {
                const anyChecked = Array.from(checkboxes)
                    .some(cb => !cb.disabled && cb.checked);

                submitBtn.disabled = !anyChecked;
            }

            checkboxes.forEach(cb => {
                cb.addEventListener("change", updateSubmitButtonState);
            });

            window.selectAllCategoryCheckboxes = function () {
                checkboxes.forEach(cb => {
                    if (!cb.disabled) cb.checked = true;
                });
                updateSubmitButtonState();
            };

            window.deselectAllCategoryCheckboxes = function () {
                checkboxes.forEach(cb => {
                    if (!cb.disabled) cb.checked = false;
                });
                updateSubmitButtonState();
            };

            updateSubmitButtonState();
        });

        document.addEventListener("DOMContentLoaded", function () {
            const checkboxes = document.querySelectorAll("#statusFilterForm input[type='checkbox']");

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);

                    if (checkedBoxes.length === 0) {
                        this.checked = true;
                    }
                });
            });

            statusDropdownMenu = document.querySelector('#statusFilterDropdown + .dropdown-menu');

            if (statusDropdownMenu) {
                statusDropdownMenu.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
            }

            createdByDropdownMenu = document.querySelector('#createdByFilterDropdown + .dropdown-menu');

            if (createdByDropdownMenu) {
                createdByDropdownMenu.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
            }

            editedByDropdownMenu = document.querySelector('#editedByFilterDropdown + .dropdown-menu');

            if (editedByDropdownMenu) {
                editedByDropdownMenu.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
            }

            updatedByDropdownMenu = document.querySelector('#updatedByFilterDropdown + .dropdown-menu');

            if (updatedByDropdownMenu) {
                updatedByDropdownMenu.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
            }



        });

        function validateNetChange(form) {

            const netChangeValue = parseFloat(form.querySelector('input[name="NetChange"]').value);
            if (netChangeValue !== 0) {
                window.alert("Cannot approve category: Balance is not zero.");
                return false;
            }
            return true;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const speedtypeSelect = document.getElementById('sourceSpeedtype');
            const fundCodeInput = document.getElementById('fundCode');
            const programCodeInput = document.getElementById('programCode');
            const classCodeInput = document.getElementById('classCode');

            // speedtypeSelect.addEventListener('change', function () {
            //     const selectedOption = speedtypeSelect.options[speedtypeSelect.selectedIndex];
            //     const fundCode = selectedOption.getAttribute('data-fundcode');
            //     fundCodeInput.value = fundCode || '';
            //     const programCode = selectedOption.getAttribute('data-programcode');
            //     programCodeInput.value = programCode || '';
            //     const classCode = selectedOption.getAttribute('data-classcode');
            //     classCodeInput.value = classCode || '';
            // });

        function populateFields() {
            const selectedOption = speedtypeSelect.options[speedtypeSelect.selectedIndex];
            const fundCode = selectedOption.getAttribute('data-fundcode');
            fundCodeInput.value = fundCode || '';
            const programCode = selectedOption.getAttribute('data-programcode');
            programCodeInput.value = programCode || '';
            const classCode = selectedOption.getAttribute('data-classcode');
            classCodeInput.value = classCode || '';
        }

           populateFields();
            speedtypeSelect.addEventListener('change', populateFields);

            [fundCodeInput, programCodeInput, classCodeInput].forEach(field => {
            if (field) {
                field.setAttribute('readonly', true);
                field.style.backgroundColor = '#f0f0f0';
            }
            });

            const modal = document.getElementById('extendDeadlineModal');
            modal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const category = button.getAttribute('data-category');
            const categoryInput = modal.querySelector('#modalCategory');
            categoryInput.value = category;
        });

        });

    </script>

<style>
    .nav-pills .nav-link {
        color: #495057;
        background-color: #f8f9fa;
        transition: background-color 0.3s ease;
    }

        .nav-pills .nav-link:hover {
            background-color: #e2e6ea;
        }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
</style>
